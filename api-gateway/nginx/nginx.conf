worker_processes 1;

env JWT_SECRET; # Pass JWT_SECRET from environment to nginx

events {
    worker_connections 1024;
}

http {
    resolver 127.0.0.11 ipv6=off; # Docker internal DNS resolver

    include       /usr/local/openresty/nginx/conf/mime.types;
    default_type  text/plain;

    lua_shared_dict live 1m;

    # Lua functions to get live stack and available stacks
    init_by_lua_block {
        function get_live_stack()
            local f = io.open("/etc/nginx/api_state/live", "r")
            if not f then return "_v1_0" end
            local stack = f:read("*l") or "_v1_0"
            f:close()
            return stack:gsub("%s+$", "")
        end

        function get_available_stacks()
            local f = io.open("/etc/nginx/api_state/available", "r")
            if not f then return {"_v1_0"} end
            local content = f:read("*a")
            f:close()
            local stacks = {}
            for s in string.gmatch(content, "[^,%s]+") do
                table.insert(stacks, s)
            end
            return stacks
        end
    }

    sendfile on;
    gzip off;
    keepalive_timeout 65;

    # Load all site configs
    include /etc/nginx/conf.d/*.conf;
}
