server {
    listen 8198 ssl;
    server_name api.teesal25.treok.eu www.api.teesal25.treok.eu;

    ssl_certificate /etc/nginx/certs/server.crt;
    ssl_certificate_key /etc/nginx/certs/server.key;

    # Get the current live stack version
    set_by_lua_block $live { 
        return get_live_stack()
    }

    # Dynamically determine the old stack to discard 
    set_by_lua_block $discard_version { 
        local live = get_live_stack()
        local stacks = get_available_stacks()
        for _, s in ipairs(stacks) do
            if s ~= live then return s end 
        end 
        return "" 
    }

    # DISCARD OLD → proxy to active monitor with X-Discard-Version 
    location /discard-old { 
        access_by_lua_file /etc/nginx/lua/jwt_auth.lua; # Only authenticated users can discard old version

        # Remove old stack from available stacks file
        header_filter_by_lua_block {
            local live = get_live_stack()
            local stacks = get_available_stacks()
            local old

            for _, s in ipairs(stacks) do
                if s ~= live then
                    old = s
                    break
                end
            end

            if old and old ~= "" then
                local f, err = io.open("/etc/nginx/api_state/available", "w")
                if f then
                    for _, s in ipairs(stacks) do
                        if s ~= old then
                            f:write(s .. "\n")
                        end
                    end
                    f:close()
                else
                    ngx.log(ngx.ERR, "Failed to update available stacks file: ", err)
                end
            end
        }
        
        proxy_set_header X-Discard-Version $discard_version;
        proxy_set_header Authorization $http_authorization;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass http://monitor$live:8198/discard-old; 
    }

    # SWITCH VERSION → changes live stack
    location /switch-version {
        access_by_lua_file /etc/nginx/lua/jwt_auth.lua; # Only authenticated users can switch version

        content_by_lua_block {
            local current = get_live_stack()
            local stacks = get_available_stacks()
            local target
            for _, s in ipairs(stacks) do
                if s ~= current then
                    target = s
                    break
                end
            end
            if not target then
                ngx.status = 500
                ngx.say("No alternate stack available")
                return
            end
            local f, err = io.open("/etc/nginx/api_state/live", "w")
            if not f then
                ngx.status = 500
                ngx.say("Failed to open live file: ", err)
                return
            end
            f:write(target)
            f:close()
            ngx.say("Switched live stack from ", current, " to ", target)
        }
    }

    # / → proxy to monitor
    location / { 
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass http://monitor$live:8198;
    }
}